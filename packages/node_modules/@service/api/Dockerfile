## Stage 1 - Build host
FROM node:10-alpine AS buildhost
WORKDIR /build
COPY . .
RUN npm install && npm run build

## Stage 2 - Deployment image
FROM node:10-alpine

# Install chamber
RUN  apk update && apk upgrade \
  && apk add --no-cache ca-certificates wget \
  && update-ca-certificates

RUN wget https://github.com/segmentio/chamber/releases/download/v2.3.2/chamber-v2.3.2-linux-amd64 -O /bin/chamber && \
chmod +x /bin/chamber

# Change to workdir
WORKDIR /app

# Install production dependencies
COPY ./package* ./
RUN npm install && npm cache clean --force

# Copy application
COPY --from=buildhost /build/index.js /app/index.js
COPY --from=buildhost /build/dist /app/dist

# Expose the port we use
EXPOSE 3000

# Run!
CMD ["node", "."]